<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Employee Attendance Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0f172a;
            overflow: hidden;
            overscroll-behavior-y: contain;
        }

        .bg-gradient {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 0% 0%, #1e293b 0%, transparent 50%),
                        radial-gradient(circle at 100% 100%, #1e3a8a 0%, transparent 50%),
                        radial-gradient(circle at 100% 0%, #0f172a 0%, transparent 50%),
                        radial-gradient(circle at 0% 100%, #312e81 0%, transparent 50%);
            background-color: #020617;
        }

        .blob {
            position: absolute;
            width: 300px; height: 300px;
            background: linear-gradient(135deg, #3b82f6 0%, #2dd4bf 100%);
            filter: blur(60px); opacity: 0.15; border-radius: 50%;
            animation: move 20s infinite alternate;
        }

        @keyframes move {
            from { transform: translate(-10%, -10%); }
            to { transform: translate(10%, 10%); }
        }

        .glass-card { 
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem;
        }

        .btn-action { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-action:active { transform: scale(0.95); filter: brightness(0.8); }

        .input-glass {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; appearance: none;
        }

        #reader {
            width: 100% !important;
            border-radius: 1.5rem;
            overflow: hidden;
            background: #000;
        }

        .btn-modern {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .btn-modern:hover {
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .scale-in { animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 relative">

    <div class="bg-gradient"></div>
    <div class="blob"></div>

    <div id="login-view" class="w-full max-w-md flex-1 flex flex-col justify-center z-50 hidden">
        <div class="glass-card p-10 text-center space-y-6">
            <div class="flex justify-center">
                <div class="bg-blue-600/20 p-4 rounded-2xl backdrop-blur-md border border-blue-500/30">
                    <i class="fa-solid fa-user-plus text-blue-400 text-4xl"></i>
                </div>
            </div>
            <div>
                <h1 class="text-3xl font-black text-white tracking-tight">ATTENDANCE<span class="text-blue-500">HUB</span></h1>
                <p class="text-blue-200/60 text-sm mt-2 font-medium">One-Time Registration</p>
            </div>

            <div class="space-y-4 text-left">
                <div>
                    <label class="text-[10px] font-bold text-blue-400 uppercase tracking-widest ml-1">Email Address</label>
                    <input type="email" id="auth-email" placeholder="name@company.com" class="w-full px-4 py-3 mt-1 input-glass rounded-xl focus:outline-none">
                </div>
                <div class="relative">
                    <label class="text-[10px] font-bold text-blue-400 uppercase tracking-widest ml-1">Password</label>
                    <input type="password" id="auth-password" placeholder="••••••••" class="w-full px-4 py-3 mt-1 input-glass rounded-xl focus:outline-none">
                    <button onclick="togglePassword()" class="absolute right-4 top-9 text-white/40 hover:text-white">
                        <i class="fa-solid fa-eye" id="password-icon"></i>
                    </button>
                </div>
                <div class="text-right">
                    <button onclick="forgotPassword()" class="text-[10px] font-bold text-blue-400 uppercase tracking-widest hover:text-blue-300 transition-colors">Forgot Password?</button>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="handleAuth('signin')" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold btn-action shadow-xl">Sign In</button>
                <button onclick="handleAuth('signup')" class="w-full py-4 bg-white/10 text-white rounded-xl font-bold btn-action border border-white/10">Register Account</button>
            </div>
        </div>
    </div>

    <div id="app-content" class="w-full max-w-md hidden z-10 flex-1 flex flex-col">
        <div class="pt-4 pb-6 flex justify-between items-center px-2">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600/20 p-2 rounded-lg border border-blue-500/30">
                    <i class="fa-solid fa-fingerprint text-blue-400 text-xl"></i>
                </div>
                <span class="font-extrabold text-white tracking-widest text-sm uppercase">Portal</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-[10px] font-bold font-mono text-blue-100 bg-blue-500/10 border border-blue-500/20 px-3 py-1.5 rounded-full" id="clock">00:00:00</div>
                <button onclick="logout()" class="text-white/40 hover:text-red-400"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </div>
        
        <div class="flex bg-white/5 p-1 rounded-2xl mb-6 relative border border-white/10 backdrop-blur-md">
            <button onclick="switchTab('scan')" class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest text-white transition z-10" id="tab-scan">Scan QR</button>
            <button onclick="switchTab('action')" class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest text-gray-400 transition z-10" id="tab-action">Manual</button>
            <div id="slider" class="absolute w-[calc(50%-4px)] h-[calc(100%-8px)] top-[4px] left-[4px] transition-all duration-500 ease-out">
                <div class="bg-blue-600 shadow-lg w-full h-full rounded-xl"></div>
            </div>
        </div>

        <div id="view-scan" class="glass-card p-6 text-center space-y-6 relative overflow-hidden flex-1 flex flex-col justify-center">
            <div id="scan-loader" class="absolute inset-0 bg-slate-950/90 z-30 flex flex-col items-center justify-center hidden backdrop-blur-md">
                <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-white font-bold animate-pulse text-sm">Verifying QR Match...</p>
            </div>

            <div id="success-modal" class="absolute inset-0 z-40 flex flex-col items-center justify-center bg-emerald-600/95 hidden backdrop-blur-lg">
                <div class="scale-in flex flex-col items-center text-white text-center p-6">
                    <i class="fa-solid fa-check-double text-6xl mb-4"></i>
                    <h3 class="text-2xl font-black uppercase tracking-tight" id="modal-action-text">Action Logged</h3>
                    <p class="text-emerald-100 mt-2 font-medium" id="modal-name-text"></p>
                </div>
            </div>

            <div class="py-2">
                <h2 class="text-2xl font-extrabold text-white">Device Pairing</h2>
                <p class="text-blue-200/60 text-xs mt-1">Scan the QR code assigned to your ID</p>
            </div>
            
            <div class="flex justify-center">
                <div class="p-1.5 bg-white/10 rounded-[2rem] w-full aspect-square max-w-[280px] overflow-hidden relative shadow-2xl">
                    <div id="reader"></div>
                </div>
            </div>
            <p class="text-[10px] uppercase tracking-[0.3em] text-blue-400/50 font-black" id="scanner-status">Scanner Ready</p>
        </div>

        <div id="view-action" class="glass-card p-8 hidden relative overflow-hidden">
            <div id="loader" class="absolute inset-0 bg-slate-950/80 z-20 flex items-center justify-center hidden">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500"></i>
            </div>
            <h2 class="text-xl font-extrabold text-white text-center mb-8 uppercase tracking-widest">Attendance Logs</h2>
            <div class="space-y-4">
                <button onclick="logManualAction('Time In')" class="w-full btn-modern p-5 rounded-2xl flex items-center justify-between group">
                    <div class="flex items-center gap-5">
                        <div class="w-12 h-12 rounded-2xl bg-emerald-500/20 flex items-center justify-center text-emerald-400 border border-emerald-500/20">
                            <i class="fa-solid fa-sun text-xl"></i>
                        </div>
                        <div class="text-left">
                            <p class="text-white font-bold text-sm">Start Shift</p>
                            <p class="text-white/30 text-[9px] uppercase font-black tracking-widest">Time In</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-arrow-right text-white/10 group-hover:translate-x-1 transition-transform"></i>
                </button>

                <button onclick="logManualAction('Lunch Out')" class="w-full btn-modern p-5 rounded-2xl flex items-center justify-between group">
                    <div class="flex items-center gap-5">
                        <div class="w-12 h-12 rounded-2xl bg-amber-500/20 flex items-center justify-center text-amber-400 border border-amber-500/20">
                            <i class="fa-solid fa-utensils text-xl"></i>
                        </div>
                        <div class="text-left">
                            <p class="text-white font-bold text-sm">Lunch Break</p>
                            <p class="text-white/30 text-[9px] uppercase font-black tracking-widest">Lunch Out</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-arrow-right text-white/10 group-hover:translate-x-1 transition-transform"></i>
                </button>

                <button onclick="logManualAction('Lunch Back')" class="w-full btn-modern p-5 rounded-2xl flex items-center justify-between group">
                    <div class="flex items-center gap-5">
                        <div class="w-12 h-12 rounded-2xl bg-blue-500/20 flex items-center justify-center text-blue-400 border border-blue-500/20">
                            <i class="fa-solid fa-clock-rotate-left text-xl"></i>
                        </div>
                        <div class="text-left">
                            <p class="text-white font-bold text-sm">Return to Work</p>
                            <p class="text-white/30 text-[9px] uppercase font-black tracking-widest">Lunch Back</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-arrow-right text-white/10 group-hover:translate-x-1 transition-transform"></i>
                </button>

                <button onclick="logManualAction('Time Out')" class="w-full btn-modern p-5 rounded-2xl flex items-center justify-between group">
                    <div class="flex items-center gap-5">
                        <div class="w-12 h-12 rounded-2xl bg-red-500/20 flex items-center justify-center text-red-400 border border-red-500/20">
                            <i class="fa-solid fa-moon text-xl"></i>
                        </div>
                        <div class="text-left">
                            <p class="text-white font-bold text-sm">End Shift</p>
                            <p class="text-white/30 text-[9px] uppercase font-black tracking-widest">Time Out</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-arrow-right text-white/10 group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 left-4 right-4 bg-white text-slate-900 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transition-all duration-500 opacity-0 translate-y-10 pointer-events-none z-[100] max-w-md mx-auto font-bold text-xs uppercase">
        <span id="toastMsg">Notification</span>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAxBT0oESoL62oz_x_Z8cMtdENWZPx4tMI",
            authDomain: "pinotp-d7ef5.firebaseapp.com",
            databaseURL: "https://pinotp-d7ef5-default-rtdb.firebaseio.com",
            projectId: "pinotp-d7ef5",
            storageBucket: "pinotp-d7ef5.firebasestorage.app",
            messagingSenderId: "708458917827",
            appId: "1:708458917827:web:375de278577df0adcf9776"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Enable Session Persistence (Local = stays logged in)
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        let currentUserData = null;
        let html5QrCode = null;
        let isScanning = false;

        // --- AUTH ---
        function togglePassword() {
            const p = document.getElementById('auth-password');
            p.type = p.type === 'password' ? 'text' : 'password';
        }

        async function forgotPassword() {
            const email = document.getElementById('auth-email').value.trim();
            if(!email) return showToast("Enter email first");
            auth.sendPasswordResetEmail(email).then(() => showToast("Reset Link Sent")).catch(e => showToast(e.message));
        }

        async function handleAuth(type) {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) return showToast("Fields Required");

            try {
                // Verify against Admin Dashboard list
                const empSnap = await db.ref('employees').orderByChild('email').equalTo(email).once('value');
                if (!empSnap.exists()) return showToast("Email not found in admin registry");

                if (type === 'signup') {
                    await auth.createUserWithEmailAndPassword(email, password);
                    // Update admin dashboard to mark as registered
                    const key = Object.keys(empSnap.val())[0];
                    await db.ref(`employees/${key}`).update({ registered: true, registerDate: Date.now() });
                    showToast("Registration Complete");
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (e) { showToast(e.message); }
        }

        // --- SESSION PERSISTENCE ---
        auth.onAuthStateChanged(async (user) => {
            const loginView = document.getElementById('login-view');
            const appContent = document.getElementById('app-content');
            if (user) {
                // Fetch full info from Admin node
                const snap = await db.ref('employees').orderByChild('email').equalTo(user.email).once('value');
                if (snap.exists()) {
                    const data = snap.val();
                    const key = Object.keys(data)[0];
                    currentUserData = { ...data[key], id: key };
                    
                    loginView.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    switchTab('scan');
                }
            } else {
                stopScanner();
                loginView.classList.remove('hidden');
                appContent.classList.add('hidden');
            }
        });

        function logout() { auth.signOut(); }

        // --- SCANNER LOGIC (STRICT QR MATCH) ---
        async function startScanner() {
            if(isScanning) return;
            try {
                if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
                await html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, onScanSuccess);
                isScanning = true;
                document.getElementById('scanner-status').innerText = "LIVE SCANNING";
            } catch (err) { console.error(err); }
        }

        async function stopScanner() {
            if(isScanning && html5QrCode) {
                try { await html5QrCode.stop(); isScanning = false; } catch (e) {}
            }
        }

        function onScanSuccess(decodedText) {
            const scannedId = decodedText.trim().toUpperCase();
            
            // Security: QR must match the logged-in User's ID or Email
            if (scannedId !== currentUserData.id && decodedText !== currentUserData.email) {
                showToast("Access Denied: QR does not match your account");
                return;
            }

            stopScanner();
            document.getElementById('scan-loader').classList.remove('hidden');
            
            const today = new Date().toISOString().split('T')[0];
            const nowTime = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });

            db.ref(`attendance/${today}/${currentUserData.id}`).once('value', (attSnap) => {
                let action = "";
                let update = { name: currentUserData.name, timestamp: firebase.database.ServerValue.TIMESTAMP };
                const att = attSnap.val();

                if (!att) { action = "Time In"; update.TimeIn = nowTime; }
                else if (!att.LunchOut) { action = "Lunch Out"; update.LunchOut = nowTime; }
                else if (!att.LunchBack) { action = "Lunch Back"; update.LunchBack = nowTime; }
                else if (!att.TimeOut) { action = "Time Out"; update.TimeOut = nowTime; }
                else { handleScanError("Full Daily Logs Recorded"); return; }

                update.lastAction = action;
                db.ref(`attendance/${today}/${currentUserData.id}`).update(update).then(() => {
                    showSuccessModal(action, currentUserData.name);
                });
            });
        }

        // --- UI UTILS ---
        function switchTab(mode) {
            const scanView = document.getElementById('view-scan');
            const actionView = document.getElementById('view-action');
            const slider = document.getElementById('slider');
            if(mode === 'scan') {
                scanView.classList.remove('hidden'); actionView.classList.add('hidden');
                slider.style.transform = 'translateX(0%)'; startScanner();
            } else {
                scanView.classList.add('hidden'); actionView.classList.remove('hidden');
                slider.style.transform = 'translateX(100%)'; stopScanner();
            }
        }

        function showSuccessModal(action, name) {
            document.getElementById('scan-loader').classList.add('hidden');
            document.getElementById('modal-action-text').innerText = action;
            document.getElementById('modal-name-text').innerText = name;
            const modal = document.getElementById('success-modal');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.add('hidden'); startScanner(); }, 3000);
        }

        function handleScanError(msg) {
            document.getElementById('scan-loader').classList.add('hidden');
            showToast(msg); setTimeout(startScanner, 3000);
        }

        function logManualAction(type) {
            if(!currentUserData) return;
            document.getElementById('loader').classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            const nowTime = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            
            const update = { lastAction: type, timestamp: firebase.database.ServerValue.TIMESTAMP };
            update[type.replace(' ', '')] = nowTime;
            
            db.ref(`attendance/${today}/${currentUserData.id}`).update(update).then(() => {
                document.getElementById('loader').classList.add('hidden');
                showToast(type + " Logged");
            });
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none'), 3000);
        }

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
    </script>
</body>
</html>
